<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="https://i.ibb.co/zk9hYZX/favicon-32x32.png" type="image/x-icon">
    <link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/weebzone/weebzone/data/Surf-TG/src/ico2.png"
        type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <title>Batman: <!-- Filename --> </title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/weebzone/weebzone/data/Surf-TG/css/plyr.css">
    <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
    <link rel="stylesheet" href="https://bootswatch.com/5/<!-- Theme -->/bootstrap.min.css">
    <script disable-devtool-auto src='https://cdn.jsdelivr.net/npm/disable-devtool'></script>
    <style>
        body {
            height: 100vh;
            margin: 0;
            justify-content: center;
            align-items: center;

        }

        .container {
            margin: auto;
            padding: 0px;
            display: flex;
            flex-wrap: wrap;
            justify-content: flex-start;
            align-items: flex-start;
            gap: 10px;
        }

        a {
            text-decoration: none;
        }

        .card {
            align-items: left;
            box-shadow: none;
            border-radius: 0%;
            max-width: 48%
        }

        .video-player {
            max-width: 48%;
            margin: auto;
            padding-bottom: 10px;
        }

        .plyr {
            border-radius: 5px;
        }

        ::-webkit-scrollbar {
            width: 5px;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        @media (max-width: 992px) {

            .video-player {
                max-width: 80%;
                margin: auto;
            }

            .card {
                align-items: left;
                box-shadow: none;
                border-radius: 0%;
                max-width: 80%
            }

            .navbar {
                padding-right: 15px;
                padding-left: 15px;
            }
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg bg-primary mb-3 p-1" data-bs-theme="dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <img src="https://i.ibb.co/Lz7R6pCK/Picsart-25-04-22-21-49-37-806.png" alt="Logo"
                    height="40">
            </a>
            <div class="d-flex">
                <form id="signoutForm" action="/logout" method="post" class="d-flex" role="logout">
                    <button type="submit" class="btn btn-secondary btn-sm"><i class="bi bi-box-arrow-left"></i>
                        Logout</button>
                </form>
            </div>

        </div>
    </nav>
    <div class="video-player">
        <video controls playsinline id="player">
            <source src="#" type="video/mp4" />
        </video>
    </div>
    <div class="card bg-light mb-3" style="margin: auto; border-radius: 5px;">
        <div class="card-body">
            <h6 class="card-title">Name: <!-- Filename --></h6>
            <p class="card-text">Size: <!-- Size --></p>
        </div>
    </div>
    <div class="container d-flex justify-content-center align-items-center" style="width: 100%; padding: 0 5px;">
        <div onclick="mx_player()" class="btn btn-primary">MX Player Pro</div>
        <div onclick="vlc_player()" class="btn btn-primary">VLC Mobile</div>
        <div onclick="km_player()" class="btn btn-primary">KM Player</div>
        <div onclick="get_file()" class="btn btn-primary">Get File</div>
        <div onclick="copyUrl()" class="btn btn-primary">Copy Url</div>
        <div onclick="download()" class="btn btn-primary">Download</div>
    </div>
    <footer class="footer mt-auto py-3 text-muted text-center" style="color: white;">
        <div class="container d-flex justify-content-center align-items-center" style="width: 100%; padding: 0 10px;">
            <p class="float-end">
            <p>Made with <svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-heart-fill" fill="red"
                    xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd"
                        d="M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314z" />
                </svg> by <a href="https://t.me/batmanlinkz" target="_blank">Batman</a><br>
                &copy; 2025 <a href="https://t.me/batmanlinkz" target="_blank">I Am Batman</a>. All Rights
                Reserved.
        </div>
    </footer>
</body>
<script>
/*
  Auto-find working video source on page load.
  Strategy:
    1. Build candidate URLs (several variants).
    2. For each candidate:
       a) Try HEAD or Range 0-1 fetch to confirm it's a video and supports ranges.
       b) If fetch blocked by CORS or HEAD inconclusive, try setting video.src and wait for canplay/error.
    3. Use first successful candidate. If none, leave video blank and log errors.
*/

/* ----- Helpers ----- */
function buildCandidates() {
  const videolink = window.location.href;
  const url = new URL(videolink);
  const domainUrl = url.origin;

  const videoIdWithParams = videolink.split('/').pop();
  const videoId = videoIdWithParams.split('?')[0] || '';
  const idParam = url.searchParams.get('id') || '';
  const hashParam = url.searchParams.get('hash') || '';
  const filenameTemplate = '<!-- Filename -->'; // keep template placeholder
  const encodedName = encodeURIComponent(filenameTemplate);

  const candidates = [];

  // Candidate: exact pattern you used
  if (videoId) candidates.push(`${domainUrl}/${videoId}/${encodedName}?id=${idParam}&hash=${hashParam}`);

  // Variants (common mistakes / alternatives)
  if (videoId) {
    candidates.push(`${domainUrl}/${videoId}/${encodedName}`); // no query
    candidates.push(`${domainUrl}/${videoId}/`); // only id path
    candidates.push(`${domainUrl}/${videoId}?id=${idParam}&hash=${hashParam}`); // no filename
  }

  // With raw filename (unencoded)
  candidates.push(`${domainUrl}/${videoId}/${filenameTemplate}?id=${idParam}&hash=${hashParam}`);

  // If page itself might already be direct file (some setups)
  candidates.push(videolink);

  // Remove duplicates and empty
  return [...new Set(candidates.filter(u => u && !u.includes('undefined') && !u.includes('null')))];
}

/**
 * Try a HEAD request (or Range) to quickly validate a URL.
 * Returns an object { ok: boolean, reason: string, supportsRange: boolean }
 */
async function testHeadOrRange(url, timeoutMs = 5000) {
  // Try Range (bytes=0-1) first to detect partial content and video content-type.
  try {
    const controller = new AbortController();
    const id = setTimeout(() => controller.abort(), timeoutMs);

    const resp = await fetch(url, {
      method: 'GET', // some servers block HEAD; use GET for Range test but only request 0-1
      headers: { 'Range': 'bytes=0-1' },
      signal: controller.signal,
      mode: 'cors'
    });
    clearTimeout(id);

    // If we get 206 or 200 and content-type is video/*, treat as promising.
    const ct = resp.headers.get('content-type') || '';
    const ar = resp.headers.get('accept-ranges') || '';
    const status = resp.status;

    // If response body is HTML (content-type text/html) — reject
    if (!ct.includes('video')) {
      return { ok: false, reason: `bad content-type: ${ct}`, supportsRange: (ar.includes('bytes')) };
    }
    // If server returned 206 or has Accept-Ranges header, good
    if (status === 206 || ar.includes('bytes')) {
      return { ok: true, reason: `206 or Accept-Ranges present (status ${status})`, supportsRange: true };
    }
    // status 200 with video content — maybe works but no range
    if (status === 200) {
      return { ok: true, reason: `status 200 with video content (no Accept-Ranges)`, supportsRange: false };
    }
    return { ok: false, reason: `unexpected status ${status}`, supportsRange: (ar.includes('bytes')) };
  } catch (err) {
    // fetch failed — could be CORS, network, or abort
    return { ok: false, reason: `fetch-range failed: ${err.message}`, supportsRange: false };
  }
}

/**
 * Try setting video.src and wait for canplay / error with timeout.
 */
function testVideoElement(url, timeLimit = 7000) {
  return new Promise(resolve => {
    const video = document.createElement('video');
    let settled = false;

    function cleanUp() {
      video.removeAttribute('src');
      video.load();
      video.removeEventListener('canplay', onCanPlay);
      video.removeEventListener('loadedmetadata', onCanPlay);
      video.removeEventListener('error', onError);
    }

    function onCanPlay() {
      if (settled) return;
      settled = true;
      cleanUp();
      resolve({ ok: true, reason: 'video canplay/loadedmetadata' });
    }

    function onError(e) {
      if (settled) return;
      settled = true;
      cleanUp();
      const code = video.error && video.error.code ? `code ${video.error.code}` : '';
      resolve({ ok: false, reason: `video element error ${code}` });
    }

    // Timeout fallback
    const timer = setTimeout(() => {
      if (settled) return;
      settled = true;
      cleanUp();
      resolve({ ok: false, reason: 'video element timeout' });
    }, timeLimit);

    video.addEventListener('canplay', () => { clearTimeout(timer); onCanPlay(); });
    video.addEventListener('loadedmetadata', () => { clearTimeout(timer); onCanPlay(); });
    video.addEventListener('error', (e) => { clearTimeout(timer); onError(e); });

    // Start attempt
    try {
      video.preload = 'metadata';
      video.crossOrigin = 'anonymous';
      video.src = url;
      // Some browsers require load() to start loading
      video.load();
    } catch (err) {
      clearTimeout(timer);
      settled = true;
      resolve({ ok: false, reason: `exception setting src: ${err.message}` });
    }
  });
}

/* ----- Main flow ----- */
(async function tryAllAndInit() {
  const candidates = buildCandidates();
  console.log('Video source candidates:', candidates);

  const videoEl = document.getElementById('player');
  const results = [];

  for (const candidate of candidates) {
    try {
      console.log('Testing candidate:', candidate);

      // 1) Quick HEAD/Range test
      const headResult = await testHeadOrRange(candidate, 4500);
      console.log('HEAD/Range result:', headResult);
      if (headResult.ok) {
        // If HEAD says content-type is video, we accept it (prefer those supporting range)
        // Use this candidate
        videoEl.src = candidate;
        try {
          // Wait shortly for loadedmetadata/canplay
          const elTest = await testVideoElement(candidate, 5000);
          if (elTest.ok) {
            console.log('Selected candidate (head->video ok):', candidate);
            initPlyr(); // initialize player and stop
            return;
          } else {
            // If videoElement failed, record and continue
            console.warn('Candidate failed on video element after HEAD ok:', candidate, elTest.reason);
            results.push({ candidate, reason: `head_ok_but_video_failed: ${elTest.reason}` });
            continue;
          }
        } catch (err) {
          results.push({ candidate, reason: 'head_ok_but_video_test_error' });
          continue;
        }
      }

      // 2) HEAD/Range inconclusive or blocked (CORS etc) -> try direct video test
      const videoTest = await testVideoElement(candidate, 7000);
      console.log('video element test result:', videoTest);
      if (videoTest.ok) {
        videoEl.src = candidate;
        console.log('Selected candidate (video element success):', candidate);
        initPlyr();
        return;
      } else {
        results.push({ candidate, reason: videoTest.reason });
      }
    } catch (err) {
      console.error('Error testing candidate', candidate, err);
      results.push({ candidate, reason: 'exception ' + (err && err.message) });
    }
  }

  // None succeeded
  console.error('No working video candidate found. Details:', results);
  // Optionally show a friendly message on the page:
  const cardBody = document.querySelector('.card-body');
  if (cardBody) {
    const errNode = document.createElement('p');
    errNode.style.color = 'red';
    errNode.textContent = 'Video could not be loaded automatically. Try Download or open with external player.';
    cardBody.appendChild(errNode);
  }
})();

/* ----- Plyr init helper ----- */
function initPlyr() {
  // Avoid double-init if already there
  try {
    if (window.plyrInstance) return;
    window.plyrInstance = new Plyr('#player', {
      controls: [
        'play', 'progress', 'current-time', 'mute', 'volume',
        'fullscreen', 'pip', 'airplay', 'settings', 'play-large', 'duration'
      ],
      hideControls: false,
      keyboard: { focused: true, global: true },
      loop: { active: false }
    });
    // Optional: autoplay attempt (may be blocked)
    // document.getElementById('player').play().catch(()=>{});
    console.log('Plyr initialized.');
  } catch (e) {
    console.error('Plyr init error:', e);
  }
}

/* ----- External player / button functions (use same candidate building logic) ----- */
function getDownloadLink() {
  // Build same candidate string as primary (first candidate)
  const vlink = window.location.href;
  const url = new URL(vlink);
  const domainUrl = url.origin;
  const videoIdWithParams = vlink.split('/').pop();
  const videoId = videoIdWithParams.split('?')[0] || '';
  const idParam = url.searchParams.get('id') || '';
  const hashParam = url.searchParams.get('hash') || '';
  const encodedName = encodeURIComponent('<!-- Filename -->');
  return `${domainUrl}/${videoId}/${encodedName}?id=${idParam}&hash=${hashParam}`;
}

function mx_player() {
  window.location.href = `intent:${getDownloadLink()}#Intent;package=com.mxtech.videoplayer.pro;end`;
}
function vlc_player() {
  window.location.href = `vlc://${getDownloadLink()}`;
}
function km_player() {
  window.location.href = `intent:${getDownloadLink()}#Intent;package=com.kmplayer;end`;
}
function download() {
  window.location.href = getDownloadLink();
}
function copyUrl() {
  navigator.clipboard.writeText(getDownloadLink())
    .then(() => alert('URL copied to clipboard!'))
    .catch(err => console.error('Failed to copy URL:', err));
}
function get_file() {
  const videolink = window.location.href;
  const regex = /(\d+)\?id=(\d+)&/;
  const match = videolink.match(regex);
  if (match) {
    const chatId = "-100" + match[1];
    const messageId = match[2];
    const openTG = `https://t.me/<!-- Username -->?start=file_${messageId}${chatId}`;
    window.location.href = openTG;
  }
}
</script>


</html>
